package com.example.exploit;

import ch.qos.logback.classic.Level;
import ch.qos.logback.classic.Logger;
import com.example.exploit.annotation.LdapController;
import com.example.exploit.annotation.LdapMapping;
import com.unboundid.ldap.sdk.Entry;
import org.reflections.Reflections;
import org.reflections.scanners.MethodAnnotationsScanner;
import org.reflections.scanners.TypeAnnotationsScanner;
import org.slf4j.LoggerFactory;

import java.lang.reflect.Method;
import java.util.Hashtable;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public class Dispatcher {
    public static void dispatch(String path, Hashtable<String, String> params, Entry e) throws Exception {
        Logger root = (Logger) LoggerFactory.getLogger("org.reflections");
        root.setLevel(Level.OFF);

        Reflections ref = new Reflections("com.example.exploit.controller",
                new TypeAnnotationsScanner(), new MethodAnnotationsScanner());
        Set<Class<?>> controllerClasses = ref.getTypesAnnotatedWith(LdapController.class);

        for (Class<?> clazz : controllerClasses) {
            LdapMapping baseMapping = clazz.getAnnotation(LdapMapping.class);
            String basePath = (baseMapping != null) ? baseMapping.value() : "";
            Method[] methods = clazz.getMethods();

            for (Method method : methods) {
                LdapMapping methodMapping = method.getAnnotation(LdapMapping.class);

                if (methodMapping != null) {
                    String mappingPath = basePath + methodMapping.value();
                    String regex = mappingPath.replaceAll("\\{.*?\\}", "([^/]+)");
                    Pattern valuePattern = Pattern.compile("^" + regex + "$");
                    Matcher valueMatcher = valuePattern.matcher(path);

                    if (valueMatcher.matches()) {
                        Pattern namePattern = Pattern.compile("\\{(.*?)\\}");
                        Matcher nameMatcher = namePattern.matcher(mappingPath);

                        int groupIndex = 1;
                        while (nameMatcher.find()) {
                            String name = nameMatcher.group(1);
                            String value = valueMatcher.group(groupIndex);
                            groupIndex ++;
                            params.put(name, value);
                        }

                        Object obj = clazz.newInstance();
                        method.invoke(obj, params);
                        clazz.getDeclaredMethod("processResult", Hashtable.class, Entry.class)
                                .invoke(obj, params, e);
                        return;
                    }
                }
            }
        }
    }
}
